{"version":3,"sources":["../src/bcplayer.js"],"names":["define","$","Event","bcs","removeDataAttr","videos","forEach","video","innerHTML","setAttribute","getAttribute","removeAttribute","loadBrightcove","videoElements","document","querySelectorAll","length","bcAccounts","Array","prototype","slice","call","map","acc","player","filter","value","index","self","indexOf","getBcModule","getLegacyEvents","done","events","one","FILTER_CONTENT_UPDATED","obj","requirejs","undef","config","paths","Promise","resolve","require","bc","initVideosByAccount","on","account","res","controls","hasClass","removeClass","console","log","remainingTime","init"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JW Player module.\n *\n * @module     media_bcplayer/bcplayer\n * @package    media_bcplayer\n * @copyright  2017 Ruslan Kabalin, Lancaster University\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/event'],($, Event) => {\n    const bcs = {}; // The object that will contain all our 'bc' RJS modules.\n\n    const removeDataAttr = (videos) => {\n        // Change all the data-player attribute to keep Brightcove from trying to\n        // initialize every player when the first script is retrieved.\n        videos.forEach((video) => {\n            video.innerHTML = '';\n            video.setAttribute('data-store-account', video.getAttribute('data-account'));\n            video.setAttribute('data-store-player', video.getAttribute('data-player'));\n            video.setAttribute('data-store-video-id', video.getAttribute('data-video-id'));\n            video.removeAttribute('data-account');\n            video.removeAttribute('data-player');\n            video.removeAttribute('data-video-id');\n        });\n    };\n\n    const loadBrightcove = async() => {\n        const videoElements = document.querySelectorAll('video-js');\n        if(videoElements.length){\n            const bcAccounts = Array.prototype.slice.call(videoElements)\n                .map((video) => ({acc : video.getAttribute('data-account'), player : video.getAttribute('data-player')}))\n                .filter((value, index, self) => self.indexOf(value) === index);\n            removeDataAttr(videoElements);\n            for (let index = 0; index < bcAccounts.length; index++) {\n                await getBcModule(bcAccounts[index]);\n            }\n        }else {\n            Event.getLegacyEvents().done((events) => {\n                $(document).one(events.FILTER_CONTENT_UPDATED, () => {\n                    loadBrightcove();\n                });\n            });\n        }\n\n    };\n\n    const getBcModule = function (obj) {\n\n        // Undefine 'bc' module so it can be reset using the next player's values.\n        // Because Brightcove's script forces itself to be named 'bc' when called as\n        // an AMD module, you have to undefine it before calling a second 'bc' module\n        // with a different url. Simply changing the path and requiring it won't work.\n        // It has to be undef'd before a second call can be made.\n        requirejs.undef('bc');\n\n        // Set the 'bc' module path using this video's account and player ids.\n        requirejs.config({\n            paths: {\n                'bc': `http://players.brightcove.net/${obj.acc}/${obj.player}_default/index.min`\n            }\n        });\n\n        return new Promise(((resolve) => {\n            // After 1 second signal that the job is finished with an error\n            require(['bc'], (bc) => {\n                // Store the current bc in bcs, because we're going to undefine it.\n                bcs[`bc${obj.acc}${obj.player}`] = bc;\n                // Initialize all the videos for this account.\n                const player = initVideosByAccount(obj);\n                player.on('loadedmetadata', () => {\n                    resolve(player);\n                });\n            });\n        }));\n    };\n\n    const initVideosByAccount = function (account) {\n        // eslint-disable-next-line max-len\n            const videos = document.querySelectorAll(`video-js[data-store-account='${account.acc}'][data-store-player='${account.player}']`);\n            let res;\n            videos.forEach((video) => {\n                video.setAttribute('data-account', video.getAttribute('data-store-account'));\n                video.setAttribute('data-player', video.getAttribute('data-store-player'));\n                video.setAttribute('data-video-id', video.getAttribute('data-store-video-id'));\n                res = bcs[`bc${account.acc}${account.player}`](video);\n                res.controls(true);\n                if (res.hasClass('vjs-play-button-shape-square')){\n                    res.removeClass('vjs-play-button-shape-square');\n                }\n                // res.on('loadedmetadata',() => {\n                //     console.log('Video duration: ' + res.duration() + 'secounds');\n                //     console.log('Video Playback speed: ' + res.playbackRate() );\n                //     console.log('User Active: ' + res.userActive() );\n                //\n                // });\n                    // Fired when the current playback position has changed * During playback this is fired every\n                    // 15-250 milliseconds, depending on the playback technology in use.\n                res.on('timeupdate', () => {\n                    // console.log('Video duration: ' + res.duration() + 'secounds');\n                    // console.log('Video Playback speed: ' + res.playbackRate() );\n                    // console.log('User Active: ' + res.userActive() );\n                    console.log('Video remaining time: ' + res.remainingTime() );\n                });\n            });\n            return res;\n    };\n\n    // Load all accounts and related players\n    return {\n        init() {\n            loadBrightcove();\n\n            $(document).on('brightcoveinsertedtodom',() => {\n                loadBrightcove();\n            });\n        }\n\n    };\n\n});\n"],"file":"bcplayer.min.js"}